FROM node:20-alpine

WORKDIR /app

COPY ../../package*.json ./
COPY ../../nest-cli.json ./
COPY ../../tsconfig*.json ./
COPY ../../libs ./libs
COPY . .

RUN npm ci --legacy-peer-deps

RUN npm run build:gateway

ARG PORT_GATEWAY
ARG URL_CORE_SERVICE
ARG URL_CLINICAL_SERVICE
ARG URL_NUTRITION_SERVICE
ARG URL_ODONTO_SERVICE
ARG URL_PATIENT_SERVICE
ARG URL_PHARMACY_SERVICE
ARG URL_VACCINATION_SERVICE

ENV PORT_GATEWAY=$PORT_GATEWAY
ENV URL_CORE_SERVICE=$URL_CORE_SERVICE
ENV URL_CLINICAL_SERVICE=$URL_CLINICAL_SERVICE
ENV URL_NUTRITION_SERVICE=$URL_NUTRITION_SERVICE
ENV URL_ODONTO_SERVICE=$URL_ODONTO_SERVICE
ENV URL_PATIENT_SERVICE=$URL_PATIENT_SERVICE
ENV URL_PHARMACY_SERVICE=$URL_PHARMACY_SERVICE
ENV URL_VACCINATION_SERVICE=$URL_VACCINATION_SERVICE

EXPOSE 3010

CMD ["node", "dist/apps/api-gateway/main.js"]